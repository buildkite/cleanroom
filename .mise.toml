[tools]
go = "1.23"
shellcheck = "latest"
hyperfine = "latest"
svu = "3"

[env]
GOTOOLCHAIN = "local"

[tasks.test]
description = "Run cross-platform Go test suite"
run = "go test ./..."

[tasks.lint-shell]
description = "Lint shell scripts"
run = "shellcheck -x scripts/cleanroom-root-helper.sh scripts/benchmark-tti.sh"

[tasks.test-full]
description = "Run full Go test suite"
run = "go test ./..."

[tasks."build:go"]
description = "Build Go binaries into dist/"
run = """
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo dev)
mkdir -p dist
go build -ldflags "-X main.version=$VERSION" -o dist/cleanroom ./cmd/cleanroom
go build -o dist/cleanroom-guest-agent ./cmd/cleanroom-guest-agent
"""

[tasks."build:darwin"]
description = "Build macOS darwin-vz helper into dist/"
run = "{% if os() == \"macos\" %}mkdir -p dist && xcrun swiftc -O -framework Virtualization cmd/cleanroom-darwin-vz/main.swift -o dist/cleanroom-darwin-vz && codesign --force --sign - --entitlements cmd/cleanroom-darwin-vz/entitlements.plist dist/cleanroom-darwin-vz{% else %}true{% endif %}"

[tasks.build]
description = "Build binaries into dist/"
depends = ["build:go", "build:darwin"]
run = "true"

[tasks."install:go"]
description = "Install Go binaries into GOBIN (or GOPATH/bin)"
run = """
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo dev)
BIN_DIR="$(go env GOBIN)"
if [ -z "$BIN_DIR" ]; then BIN_DIR="$(go env GOPATH)/bin"; fi
HOST_ARCH="$(go env GOARCH)"
mkdir -p "$BIN_DIR"
go install -ldflags "-X main.version=$VERSION" ./cmd/cleanroom ./cmd/cleanroom-guest-agent
GOOS=linux GOARCH="$HOST_ARCH" CGO_ENABLED=0 go build -trimpath -o "$BIN_DIR/cleanroom-guest-agent-linux-$HOST_ARCH" ./cmd/cleanroom-guest-agent
"""

[tasks."install:darwin"]
description = "Install macOS darwin-vz helper into GOBIN (or GOPATH/bin)"
depends = ["build:darwin"]
run = "{% if os() == \"macos\" %}BIN_DIR=\"$(go env GOBIN)\"; if [ -z \"$BIN_DIR\" ]; then BIN_DIR=\"$(go env GOPATH)/bin\"; fi; ENTITLEMENTS=\"cmd/cleanroom-darwin-vz/entitlements.plist\"; mkdir -p \"$BIN_DIR\" && install -m 0755 dist/cleanroom-darwin-vz \"$BIN_DIR/cleanroom-darwin-vz\" && codesign --force --sign - --entitlements \"$ENTITLEMENTS\" \"$BIN_DIR/cleanroom-darwin-vz\"{% else %}true{% endif %}"

[tasks.install]
description = "Install all binaries into GOBIN (or GOPATH/bin)"
depends = ["install:go", "install:darwin"]
run = "true"

[tasks.doctor]
description = "Run cleanroom diagnostics"
run = "go run ./cmd/cleanroom doctor"

[tasks.doctor-json]
description = "Run cleanroom diagnostics as JSON"
run = "go run ./cmd/cleanroom doctor --json"

[tasks.check]
description = "Run build, test, and lint"
depends = ["build", "test", "lint-shell"]
run = "true"

[tasks.release]
description = "Tag the next version and push to trigger a release"
depends = ["check"]
run = """
NEXT=$(svu next)
CURRENT=$(svu current)
if [ "$NEXT" = "$CURRENT" ]; then
  echo "No version bump detected (current: $CURRENT). Use conventional commits (feat:, fix:, etc.)."
  exit 1
fi
echo "Releasing $CURRENT -> $NEXT"
git tag "$NEXT"
git push origin "$NEXT"
echo "Tagged and pushed $NEXT â€” release workflow will run on GitHub."
"""
