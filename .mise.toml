[tools]
go = "1.23"
shellcheck = "latest"
hyperfine = "latest"
svu = "3"

[env]
GOTOOLCHAIN = "local"

[tasks.test]
description = "Run cross-platform Go test suite"
run = "go test ./..."

[tasks.lint-shell]
description = "Lint shell scripts"
run = "shellcheck -x scripts/cleanroom-root-helper.sh scripts/benchmark-tti.sh scripts/build-go.sh scripts/build-macos-app.sh scripts/install-go.sh scripts/install-macos-app.sh scripts/install.sh scripts/release.sh"

[tasks.test-full]
description = "Run full Go test suite"
run = "go test ./..."

[tasks."build:go"]
description = "Build Go binaries into dist/"
run = "scripts/build-go.sh"

[tasks."build:darwin"]
description = "Build macOS darwin-vz helper into dist/"
run = "{% if os() == \"macos\" %}mkdir -p dist && xcrun swiftc -O -framework Virtualization cmd/cleanroom-darwin-vz/main.swift -o dist/cleanroom-darwin-vz && codesign --force --sign - --entitlements cmd/cleanroom-darwin-vz/entitlements.plist dist/cleanroom-darwin-vz{% else %}true{% endif %}"

[tasks."build:macos-app"]
description = "Build macOS menubar app bundle into dist/"
depends = ["build:go", "build:darwin"]
run = "{% if os() == \"macos\" %}scripts/build-macos-app.sh{% else %}true{% endif %}"

[tasks.build]
description = "Build binaries into dist/"
depends = ["build:go", "build:darwin", "build:macos-app"]
run = "true"

[tasks."install:go"]
description = "Install Go binaries into GOBIN (or GOPATH/bin)"
run = "scripts/install-go.sh"

[tasks."install:darwin"]
description = "Install macOS darwin-vz helper into GOBIN (or GOPATH/bin)"
depends = ["build:darwin"]
run = "{% if os() == \"macos\" %}BIN_DIR=\"$(go env GOBIN)\"; if [ -z \"$BIN_DIR\" ]; then BIN_DIR=\"$(go env GOPATH)/bin\"; fi; ENTITLEMENTS=\"cmd/cleanroom-darwin-vz/entitlements.plist\"; mkdir -p \"$BIN_DIR\" && install -m 0755 dist/cleanroom-darwin-vz \"$BIN_DIR/cleanroom-darwin-vz\" && codesign --force --sign - --entitlements \"$ENTITLEMENTS\" \"$BIN_DIR/cleanroom-darwin-vz\"{% else %}true{% endif %}"

[tasks."install:macos-app"]
description = "Install macOS menubar app to ~/Applications (override with CLEANROOM_APP_INSTALL_DIR)"
depends = ["build:macos-app"]
run = "{% if os() == \"macos\" %}scripts/install-macos-app.sh{% else %}true{% endif %}"

[tasks.install]
description = "Install all binaries into GOBIN (or GOPATH/bin)"
depends = ["install:go", "install:darwin", "install:macos-app"]
run = "true"

[tasks.doctor]
description = "Run cleanroom diagnostics"
run = "go run ./cmd/cleanroom doctor"

[tasks.doctor-json]
description = "Run cleanroom diagnostics as JSON"
run = "go run ./cmd/cleanroom doctor --json"

[tasks.check]
description = "Run build, test, and lint"
depends = ["build", "test", "lint-shell"]
run = "true"

[tasks.release]
description = "Tag the next version and push to trigger a release"
depends = ["check"]
run = "scripts/release.sh"
