[tools]
go = "1.23"

[env]
GOTOOLCHAIN = "local"

[tasks.test]
description = "Run Go test suite"
run = "if [ \"$(go env GOOS)\" = \"linux\" ]; then go test ./...; else pkgs=$(go list ./...) || exit 1; pkgs=$(printf '%s\\n' \"$pkgs\" | grep -v '^github.com/buildkite/cleanroom/cmd/cleanroom-guest-agent$' || true); go test $pkgs; fi"

[tasks.build]
description = "Build binaries into dist/"
run = "mkdir -p dist && go build -o dist/cleanroom ./cmd/cleanroom && GOOS=linux GOARCH=$(go env GOARCH) go build -o dist/cleanroom-guest-agent ./cmd/cleanroom-guest-agent"

[tasks.install]
description = "Install binaries into GOBIN (or GOPATH/bin)"
run = "go install ./cmd/cleanroom ./cmd/cleanroom-guest-agent"

[tasks.prepare-firecracker-image]
description = "Prepare rootfs image with guest agent and tiny init (requires sudo)"
depends = ["build", "install"]
run = "sudo scripts/prepare-firecracker-image.sh"

[tasks.doctor]
description = "Run cleanroom diagnostics"
run = "go run ./cmd/cleanroom doctor"

[tasks.doctor-json]
description = "Run cleanroom diagnostics as JSON"
run = "go run ./cmd/cleanroom doctor --json"
